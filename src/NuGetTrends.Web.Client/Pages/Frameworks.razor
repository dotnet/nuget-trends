@page "/frameworks"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ThemeState ThemeState
@inject ILogger<Frameworks> Logger
@implements IDisposable

<PageTitle>NuGet Trends - Framework Adoption</PageTitle>

<div id="chartz">
    <section class="section">
        <div class="columns is-centered">
            <div class="column has-text-centered">
                <h2 class="title is-4">Target Framework Adoption</h2>
                <p class="subtitle is-6">
                    How quickly does the NuGet ecosystem adopt new .NET versions?
                </p>
            </div>
        </div>
    </section>
    <div class="columns is-vcentered is-centered">
        <div class="column has-text-centered-mobile is-narrow">
            <TfmViewToggle ViewMode="_viewMode" ViewModeChanged="OnViewModeChanged" />
        </div>
        <div class="column has-text-centered-mobile is-narrow">
            <TfmTimeToggle TimeMode="_timeMode" TimeModeChanged="OnTimeModeChanged" />
        </div>
        <div class="column has-text-centered-mobile is-narrow">
            <TfmFilter Groups="_familyGroups" SelectedTfms="_selectedTfms" SelectedTfmsChanged="OnFilterChanged" />
        </div>
    </div>
    <section class="section chart-section">
        <div class="columns is-centered has-text-centered">
            <div class="column is-8">
                @if (_isLoading)
                {
                    <div class="chart-loading">
                        <span class="icon is-large has-text-grey-light">
                            <i class="fa fa-bar-chart fa-3x fa-pulse"></i>
                        </span>
                    </div>
                }
                else if (_errorMessage != null)
                {
                    <p class="has-text-centered has-text-danger">@_errorMessage</p>
                }
                else if (_chartSeries.Count > 0)
                {
                    <div class="box is-shadowless chart-fade-in">
                        <ApexChart @ref="_chart"
                                   TItem="TfmChartPoint"
                                   Options="_chartOptions"
                                   Height="380"
                                   XAxisType="@(_timeMode == TfmTimeMode.Absolute ? XAxisType.Datetime : XAxisType.Numeric)">
                            @foreach (var series in _chartSeries)
                            {
                                <ApexPointSeries @key="series.Name"
                                                 TItem="TfmChartPoint"
                                                 Items="series.Points"
                                                 Name="@series.Name"
                                                 SeriesType="SeriesType.Line"
                                                 XValue="e => e.X"
                                                 YValue="e => e.Y"
                                                 Color="@series.Color" />
                            }
                        </ApexChart>
                    </div>
                }
                else
                {
                    <p class="has-text-centered">No framework adoption data available yet. Data is computed weekly.</p>
                }
            </div>
        </div>
    </section>
</div>

@code {
    [SupplyParameterFromQuery(Name = "view")]
    public string? View { get; set; }

    [SupplyParameterFromQuery(Name = "time")]
    public string? Time { get; set; }

    [SupplyParameterFromQuery(Name = "tfms")]
    public string[]? Tfms { get; set; }

    private TfmAdoptionResponse? _adoptionData;
    private List<TfmFamilyGroup> _familyGroups = [];
    private HashSet<string> _selectedTfms = [];
    private TfmViewMode _viewMode = TfmViewMode.Individual;
    private TfmTimeMode _timeMode = TfmTimeMode.Absolute;
    private bool _isLoading = true;
    private string? _errorMessage;

    private ApexChart<TfmChartPoint>? _chart;
    private ApexChartOptions<TfmChartPoint> _chartOptions = null!;
    private List<ChartSeriesData> _chartSeries = [];

    private static readonly string[] ChartColors =
    [
        "#055499", "#ff5a00", "#9bca3c", "#e91365", "#9B5094", "#DB9D47",
        "#2a7ab5", "#cc4800", "#7da830", "#b30f50", "#7a3f75", "#b07d39"
    ];

    protected override void OnInitialized()
    {
        if (Enum.TryParse<TfmViewMode>(View, ignoreCase: true, out var viewMode))
        {
            _viewMode = viewMode;
        }

        if (Enum.TryParse<TfmTimeMode>(Time, ignoreCase: true, out var timeMode))
        {
            _timeMode = timeMode;
        }

        ThemeState.ThemeChanged += OnThemeChanged;
        _chartOptions = BuildChartOptions();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            var availableTask = Http.GetFromJsonAsync("/api/framework/available", NuGetTrendsJsonContext.Default.ListTfmFamilyGroup);
            var adoptionTask = Http.GetFromJsonAsync("/api/framework/adoption", NuGetTrendsJsonContext.Default.TfmAdoptionResponse);

            await Task.WhenAll(availableTask, adoptionTask);

            _familyGroups = availableTask.Result ?? [];
            _adoptionData = adoptionTask.Result;

            SelectDefaultTfms();
            RebuildChartSeries();
            UpdateUrl();

            _isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading framework data");
            _errorMessage = "Failed to load framework data. Please try again later.";
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void SelectDefaultTfms()
    {
        if (_adoptionData == null) return;

        // If TFMs were provided via query string, use those (filtered to valid ones)
        if (Tfms is { Length: > 0 })
        {
            var validTfms = _adoptionData.Series.Select(s => s.Tfm).ToHashSet(StringComparer.OrdinalIgnoreCase);
            _selectedTfms = Tfms.Where(t => validTfms.Contains(t)).ToHashSet(StringComparer.OrdinalIgnoreCase);
            if (_selectedTfms.Count > 0) return;
        }

        _selectedTfms = _adoptionData.Series
            .OrderByDescending(s => s.DataPoints.LastOrDefault()?.CumulativeCount ?? 0)
            .Take(10)
            .Select(s => s.Tfm)
            .ToHashSet();
    }

    private void RebuildChartSeries()
    {
        if (_adoptionData == null || _selectedTfms.Count == 0)
        {
            _chartSeries = [];
            return;
        }

        _chartSeries = _viewMode == TfmViewMode.Family
            ? BuildFamilySeries()
            : BuildIndividualSeries();
    }

    private List<ChartSeriesData> BuildIndividualSeries()
    {
        var result = new List<ChartSeriesData>();
        var colorIndex = 0;

        foreach (var series in _adoptionData!.Series.Where(s => _selectedTfms.Contains(s.Tfm)))
        {
            var color = ChartColors[colorIndex % ChartColors.Length];
            colorIndex++;

            var points = _timeMode == TfmTimeMode.Absolute
                ? series.DataPoints
                    .Select(dp => new TfmChartPoint(ToJsTimestamp(dp.Month), (decimal)dp.CumulativeCount))
                    .ToList()
                : series.DataPoints
                    .Select((dp, i) => new TfmChartPoint(i, (decimal)dp.CumulativeCount))
                    .ToList();

            result.Add(new ChartSeriesData(series.Tfm, color, points));
        }

        return result;
    }

    private List<ChartSeriesData> BuildFamilySeries()
    {
        var familyData = new Dictionary<string, SortedDictionary<string, decimal>>();

        foreach (var series in _adoptionData!.Series.Where(s => _selectedTfms.Contains(s.Tfm)))
        {
            if (!familyData.TryGetValue(series.Family, out var monthData))
            {
                monthData = new SortedDictionary<string, decimal>();
                familyData[series.Family] = monthData;
            }

            foreach (var dp in series.DataPoints)
            {
                var key = dp.Month.ToString("yyyy-MM-dd");
                monthData[key] = monthData.TryGetValue(key, out var existing)
                    ? existing + dp.CumulativeCount
                    : dp.CumulativeCount;
            }
        }

        var result = new List<ChartSeriesData>();
        var colorIndex = 0;

        foreach (var (family, monthData) in familyData)
        {
            var color = ChartColors[colorIndex % ChartColors.Length];
            colorIndex++;

            var points = _timeMode == TfmTimeMode.Absolute
                ? monthData
                    .Select(kv => new TfmChartPoint(ToJsTimestamp(DateOnly.ParseExact(kv.Key, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture)), kv.Value))
                    .ToList()
                : monthData
                    .Select((kv, i) => new TfmChartPoint(i, kv.Value))
                    .ToList();

            result.Add(new ChartSeriesData(family, color, points));
        }

        return result;
    }

    private ApexChartOptions<TfmChartPoint> BuildChartOptions()
    {
        var gridColor = ThemeState.IsDark ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";
        var textColor = ThemeState.IsDark ? "#a0a0a0" : "#666666";

        return new ApexChartOptions<TfmChartPoint>
        {
            Chart = new Chart
            {
                Toolbar = new Toolbar { Show = false },
                Animations = new Animations
                {
                    Enabled = true,
                    Easing = Easing.Easeinout,
                    Speed = 400,
                    AnimateGradually = new AnimateGradually { Enabled = false },
                },
                Background = "transparent",
                FontFamily = "inherit",
                ForeColor = textColor,
            },
            Legend = new Legend { Show = true, Position = LegendPosition.Top, FontSize = "14px" },
            Markers = new Markers
            {
                Size = 4,
                Hover = new MarkersHover { SizeOffset = 3 },
                StrokeWidth = new Size(1),
                StrokeColors = new Color("#fff"),
                Shape = MarkerShape.Circle,
            },
            Stroke = new Stroke
            {
                Curve = Curve.Smooth,
                Width = 2,
            },
            Grid = new Grid
            {
                BorderColor = gridColor,
            },
            Xaxis = _timeMode == TfmTimeMode.Absolute
                ? new XAxis
                {
                    Type = XAxisType.Datetime,
                    Labels = new XAxisLabels
                    {
                        DatetimeFormatter = new DatetimeFormatter
                        {
                            Day = "dd MMM yyyy",
                            Month = "MMM yyyy",
                            Year = "yyyy",
                        },
                        Style = new AxisLabelStyle { Colors = new Color(textColor), FontSize = "13px" },
                    },
                    AxisBorder = new AxisBorder { Color = gridColor },
                    AxisTicks = new AxisTicks { Color = gridColor },
                }
                : new XAxis
                {
                    Type = XAxisType.Numeric,
                    Title = new AxisTitle { Text = "Months since first appearance" },
                    TickAmount = 10,
                    Labels = new XAxisLabels
                    {
                        Style = new AxisLabelStyle { Colors = new Color(textColor), FontSize = "13px" },
                        Formatter = @"function(val) { return Math.round(val); }",
                    },
                    AxisBorder = new AxisBorder { Color = gridColor },
                    AxisTicks = new AxisTicks { Color = gridColor },
                },
            Yaxis = new List<YAxis>
            {
                new()
                {
                    Labels = new YAxisLabels
                    {
                        Style = new AxisLabelStyle { Colors = new Color(textColor), FontSize = "13px" },
                        Formatter = "function(val) { return val != null && !isNaN(val) ? val.toLocaleString() : ''; }",
                    },
                },
            },
            Tooltip = new Tooltip
            {
                Theme = ThemeState.IsDark ? Mode.Dark : Mode.Light,
                // Custom tooltip showing all series sorted by value (descending).
                // Required for Relative mode where all series share identical X values
                // and ApexCharts' nearest-point detection always picks the first series.
                // Used for both modes so switching doesn't leave stale tooltip state.
                Custom = BuildCustomTooltipFunction(),
            },
        };
    }

    private async Task OnViewModeChanged(TfmViewMode mode)
    {
        _viewMode = mode;
        _chartOptions = BuildChartOptions();
        RebuildChartSeries();
        _chartSeries = [.. _chartSeries]; // new reference for Blazor change detection
        UpdateUrl();
        StateHasChanged();
        await UpdateChartAsync();
    }

    private async Task OnTimeModeChanged(TfmTimeMode mode)
    {
        _timeMode = mode;
        _chartOptions = BuildChartOptions();
        RebuildChartSeries();
        _chartSeries = [.. _chartSeries];
        UpdateUrl();
        StateHasChanged();
        await UpdateChartAsync();
    }

    private async Task OnFilterChanged(HashSet<string> selected)
    {
        _selectedTfms = selected;
        RebuildChartSeries();
        _chartSeries = [.. _chartSeries];
        UpdateUrl();
        StateHasChanged();
        await UpdateChartAsync();
    }

    private void UpdateUrl()
    {
        var queryParts = new List<string>();

        if (_viewMode != TfmViewMode.Individual)
        {
            queryParts.Add($"view={_viewMode.ToString().ToLowerInvariant()}");
        }

        if (_timeMode != TfmTimeMode.Absolute)
        {
            queryParts.Add($"time={_timeMode.ToString().ToLowerInvariant()}");
        }

        foreach (var tfm in _selectedTfms.OrderBy(t => t, StringComparer.OrdinalIgnoreCase))
        {
            queryParts.Add($"tfms={Uri.EscapeDataString(tfm)}");
        }

        var url = queryParts.Count > 0
            ? $"/frameworks?{string.Join("&", queryParts)}"
            : "/frameworks";

        Navigation.NavigateTo(url, replace: true);
    }

    private async Task UpdateChartAsync()
    {
        if (_chart is null) return;
        try
        {
            await _chart.UpdateOptionsAsync(true, true, false);
            await _chart.RenderAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to update TFM chart");
        }
    }

    private async void OnThemeChanged(object? sender, string theme)
    {
        try
        {
            await InvokeAsync(async () =>
            {
                _chartOptions = BuildChartOptions();
                StateHasChanged();
                if (_chart is not null)
                {
                    await _chart.UpdateOptionsAsync(true, true, false);
                }
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating theme for TFM chart");
        }
    }

    public void Dispose()
    {
        ThemeState.ThemeChanged -= OnThemeChanged;
    }

    private string BuildCustomTooltipFunction()
    {
        var isRelative = _timeMode == TfmTimeMode.Relative;
        var headerExpr = isRelative
            ? "'Month ' + Math.round(xVal)"
            : "new Date(xVal).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })";

        return $$"""
            function({ series, seriesIndex, dataPointIndex, w }) {
                var items = [];
                for (var i = 0; i < series.length; i++) {
                    var val = series[i][dataPointIndex];
                    if (val != null && !isNaN(val)) {
                        items.push({ name: w.config.series[i].name, color: w.config.colors[i], value: val });
                    }
                }
                items.sort(function(a, b) { return b.value - a.value; });
                var xVal = w.config.series[seriesIndex].data[dataPointIndex].x;
                var bg = w.config.tooltip.theme === 'dark' ? '#1e1e2f' : '#fff';
                var fg = w.config.tooltip.theme === 'dark' ? '#e0e0e0' : '#333';
                var header = {{headerExpr}};
                var html = '<div style="background:' + bg + ';color:' + fg + ';padding:6px 0;border-radius:4px;font-size:12px;min-width:160px">';
                html += '<div style="padding:4px 10px;border-bottom:1px solid rgba(128,128,128,0.2);font-weight:600">' + header + '</div>';
                for (var j = 0; j < items.length; j++) {
                    html += '<div style="display:flex;align-items:center;padding:3px 10px">';
                    html += '<span style="width:8px;height:8px;border-radius:50%;background:' + items[j].color + ';margin-right:6px;flex-shrink:0"></span>';
                    html += '<span>' + items[j].name + ': <b>' + items[j].value.toLocaleString() + '</b></span>';
                    html += '</div>';
                }
                html += '</div>';
                return html;
            }
            """;
    }

    private static decimal ToJsTimestamp(DateOnly date)
        => new DateTimeOffset(date.ToDateTime(TimeOnly.MinValue), TimeSpan.Zero).ToUnixTimeMilliseconds();

    // Chart data types
    private record TfmChartPoint(decimal X, decimal Y);
    private record ChartSeriesData(string Name, string Color, List<TfmChartPoint> Points);
}
