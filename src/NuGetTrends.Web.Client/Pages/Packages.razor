@page "/packages"
@page "/packages/{PackageId}"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject PackageState PackageState
@inject ThemeState ThemeState
@inject IToastService ToastService
@inject ILogger<Packages> Logger
@implements IDisposable

<PageTitle>NuGet Trends - Package Comparison</PageTitle>

<div id="chartz">
    <section class="section">
        <div class="columns is-centered">
            <PackageList />
        </div>
    </section>
    <div class="columns is-vcentered is-centered">
        <div class="column has-text-right has-text-centered-mobile is-narrow">
            <label for="period" class="title is-5">Showing results for the last: </label>
        </div>
        <div class="column has-text-centered-mobile is-narrow">
            <SearchPeriod />
        </div>
    </div>
    <section class="section chart-section">
        <div class="columns is-centered has-text-centered">
            <div class="column is-8">
                @if (_isLoading)
                {
                    <div class="chart-loading">
                        <span class="icon is-large has-text-grey-light">
                            <i class="fa fa-line-chart fa-3x fa-pulse"></i>
                        </span>
                    </div>
                }
                else if (_chartDatasets.Count > 0)
                {
                    <div class="box is-shadowless chart-fade-in">
                        <TrendChart Datasets="_chartDatasets"
                                    SearchPeriod="PackageState.SearchPeriod"
                                    IsDark="ThemeState.IsDark" />
                    </div>
                }
            </div>
        </div>
    </section>
</div>

@code {
    [Parameter]
    public string? PackageId { get; set; }

    [SupplyParameterFromQuery(Name = "ids")]
    public string[]? PackageIds { get; set; }

    [SupplyParameterFromQuery(Name = "months")]
    public int? Months { get; set; }

    private List<PackageDownloadHistory> _chartDatasets = [];
    private bool _isLoading = true;

    protected override void OnInitialized()
    {
        // Set search period from URL before subscribing to events,
        // otherwise the setter triggers OnSearchPeriodChanged with no packages loaded.
        if (Months.HasValue && Months.Value > 0)
        {
            PackageState.SearchPeriod = Months.Value;
        }

        PackageState.PackagePlotted += OnPackagePlotted;
        PackageState.PackageRemoved += OnPackageRemoved;
        PackageState.SearchPeriodChanged += OnSearchPeriodChanged;
        ThemeState.ThemeChanged += OnThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadPackagesFromUrl();
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPackagesFromUrl()
    {
        var packageIdsToLoad = new List<string>();

        // Add path parameter package
        if (!string.IsNullOrEmpty(PackageId))
        {
            packageIdsToLoad.Add(PackageId);
        }

        // Add query parameter packages
        if (PackageIds != null)
        {
            foreach (var id in PackageIds)
            {
                if (!packageIdsToLoad.Any(p => p.Equals(id, StringComparison.OrdinalIgnoreCase)))
                {
                    packageIdsToLoad.Add(id);
                }
            }
        }

        foreach (var id in packageIdsToLoad)
        {
            await LoadPackage(id);
        }

        // If no packages were loaded, navigate home
        if (PackageState.Packages.Count == 0)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task LoadPackage(string packageId)
    {
        try
        {
            var history = await Http.GetFromJsonAsync<PackageDownloadHistory>(
                $"/api/package/history/{Uri.EscapeDataString(packageId)}?months={PackageState.SearchPeriod}");

            if (history != null)
            {
                PackageState.AddPackage(history);
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            await HandlePackageNotFound(packageId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading package {PackageId}", packageId);
            ToastService.ShowError("Our servers are too cool (or not) to handle your request at the moment.");
        }
    }

    private async Task HandlePackageNotFound(string packageId)
    {
        try
        {
            var response = await Http.GetAsync(
                $"https://api.nuget.org/v3-flatcontainer/{packageId.ToLowerInvariant()}/index.json");

            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowWarning($"Package '{packageId}' exists on NuGet.org but is not yet tracked by NuGet Trends.");
            }
            else
            {
                ToastService.ShowWarning($"Package '{packageId}' doesn't exist.");
            }
        }
        catch
        {
            ToastService.ShowWarning($"Package '{packageId}' doesn't exist.");
        }

        RemovePackageFromUrl(packageId);
    }

    private async void OnPackagePlotted(object? sender, PackageDownloadHistory history)
    {
        try
        {
            await InvokeAsync(() =>
            {
                var existing = _chartDatasets.FindIndex(d => d.Id.Equals(history.Id, StringComparison.OrdinalIgnoreCase));
                if (existing >= 0)
                {
                    _chartDatasets[existing] = history;
                }
                else
                {
                    _chartDatasets.Add(history);
                }

                // New list reference so Blazor detects parameter change on TrendChart
                _chartDatasets = [.. _chartDatasets];
                UpdateUrl();
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error plotting package");
        }
    }

    private async void OnPackageRemoved(object? sender, string packageId)
    {
        try
        {
            await InvokeAsync(() =>
            {
                _chartDatasets.RemoveAll(d => d.Id.Equals(packageId, StringComparison.OrdinalIgnoreCase));
                _chartDatasets = [.. _chartDatasets];
                RemovePackageFromUrl(packageId);

                if (PackageState.Packages.Count == 0)
                {
                    Navigation.NavigateTo("/");
                }

                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error removing package");
        }
    }

    private async void OnSearchPeriodChanged(object? sender, int period)
    {
        try
        {
            await InvokeAsync(async () =>
            {
                _isLoading = true;
                StateHasChanged();

                var packageIds = PackageState.Packages.Select(p => p.Id).ToList();

                foreach (var id in packageIds)
                {
                    try
                    {
                        var history = await Http.GetFromJsonAsync<PackageDownloadHistory>(
                            $"/api/package/history/{Uri.EscapeDataString(id)}?months={period}");

                        if (history != null)
                        {
                            PackageState.UpdatePackage(history);
                        }
                    }
                    catch (Exception ex)
                    {
                        Logger.LogError(ex, "Error reloading package {PackageId}", id);
                    }
                }

                _isLoading = false;
                UpdateUrl();
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing search period");
        }
    }

    private async void OnThemeChanged(object? sender, string theme)
    {
        try
        {
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating theme");
        }
    }

    private void UpdateUrl()
    {
        var packageIds = PackageState.Packages.Select(p => p.Id).ToList();

        if (packageIds.Count == 0)
        {
            return;
        }

        var queryString = string.Join("&", packageIds.Select(id => $"ids={Uri.EscapeDataString(id)}"));
        queryString += $"&months={PackageState.SearchPeriod}";

        Navigation.NavigateTo($"/packages?{queryString}", replace: true);
    }

    private void RemovePackageFromUrl(string packageId)
    {
        var remainingIds = PackageState.Packages
            .Where(p => !p.Id.Equals(packageId, StringComparison.OrdinalIgnoreCase))
            .Select(p => p.Id)
            .ToList();

        if (remainingIds.Count == 0)
        {
            return;
        }

        var queryString = string.Join("&", remainingIds.Select(id => $"ids={Uri.EscapeDataString(id)}"));
        queryString += $"&months={PackageState.SearchPeriod}";

        Navigation.NavigateTo($"/packages?{queryString}", replace: true);
    }

    public void Dispose()
    {
        PackageState.PackagePlotted -= OnPackagePlotted;
        PackageState.PackageRemoved -= OnPackageRemoved;
        PackageState.SearchPeriodChanged -= OnSearchPeriodChanged;
        ThemeState.ThemeChanged -= OnThemeChanged;

        // Clear packages when leaving the page
        PackageState.Clear();
    }
}
